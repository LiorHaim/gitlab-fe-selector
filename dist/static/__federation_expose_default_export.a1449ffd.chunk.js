"use strict";(self.webpackChunkgitlab_fe_selector=self.webpackChunkgitlab_fe_selector||[]).push([["525"],{5240(e,t,r){r.r(t),r.d(t,{gitlabFeSelectorPlugin:()=>A,GitLabGroupPickerFieldExtension:()=>y});var n=r(7084),i=r(9584),o=r(4848),a=r(9847),l=r.n(a),s=r(2150),d=r(3182),c=r(4392),p=r(6746),u=r(7570),h=r(8311),g=r(5652),b=r(9051),f=r(9445);let m=["read_api","api"],x=e=>{let t=e.split(" ");return m.some(e=>t.includes(e))},j=["development","production","staging","default"],A=(0,n.i)({id:"gitlab-fe-selector"}),y=A.provide((0,i.z)({name:"GitLabGroupPicker",component:e=>{let{onChange:t,rawErrors:r,uiSchema:n}=e,i=n?.["ui:options"]?.allowedHosts,m=i?.[0]||"gitlab.com",[A,y]=(0,a.useState)(null),[v,k]=(0,a.useState)(null),[w,C]=(0,a.useState)(null),[S,R]=(0,a.useState)(null),[_,I]=(0,a.useState)(j[0]),[G,L]=(0,a.useState)(!1),[P,$]=(0,a.useState)(!1),[T,B]=(0,a.useState)(!0),[z,F]=(0,a.useState)(null),q=(0,a.useCallback)(async()=>{for(let e of(B(!0),F(null),L(!1),$(!1),R(null),j))try{let t=await fetch(`/api/auth/gitlab/refresh?env=${e}`,{credentials:"include",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});if(t.ok){let r=await t.json(),n=r.providerInfo?.accessToken,i=r.providerInfo?.scope||"";if(n){if(I(e),!x(i)){R(i),$(!0),B(!1);return}C(n),R(i),B(!1);return}}}catch{}L(!0),B(!1)},[]);(0,a.useEffect)(()=>{q()},[q]);let E=(0,a.useCallback)(()=>{let e=window.screenX+(window.innerWidth-500)/2,t=window.screenY+(window.innerHeight-700)/2,r=window.open(`/api/auth/gitlab/start?env=${_}`,"GitLab Sign In",`width=500,height=700,left=${e},top=${t}`);if(!r)return void F("Popup was blocked. Please allow popups for this site.");let n=setInterval(()=>{r.closed&&(clearInterval(n),setTimeout(()=>q(),1e3))},500)},[_,q]),O=(0,a.useCallback)(()=>w?{Authorization:`Bearer ${w}`}:{},[w]),{value:H,loading:W,error:X}=(0,f.A)(async()=>{if(!w)return[];let e=O(),t=await fetch(`https://${m}/api/v4/groups?min_access_level=50&per_page=100`,{headers:e});if(!t.ok)throw Error(`Failed to fetch groups: ${t.statusText}`);return await t.json()},[m,w,O]),{value:U,loading:Y}=(0,f.A)(async()=>{if(!A||!w)return[];let e=O(),t=await fetch(`https://${m}/api/v4/groups/${A.id}/projects?per_page=100`,{headers:e});if(!t.ok)throw Error(`Failed to fetch projects: ${t.statusText}`);return await t.json()},[A,m,w,O]);return T?(0,o.jsxs)(s.A,{p:2,display:"flex",alignItems:"center",children:[(0,o.jsx)(d.A,{size:20,style:{marginRight:8}}),(0,o.jsx)(c.A,{variant:"body2",children:"Checking GitLab authentication..."})]}):G?(0,o.jsxs)(s.A,{p:2,style:{border:"1px solid #ccc",borderRadius:4,backgroundColor:"#f5f5f5"},children:[(0,o.jsx)(c.A,{variant:"body1",gutterBottom:!0,children:(0,o.jsx)("strong",{children:"GitLab Authentication Required"})}),(0,o.jsx)(c.A,{variant:"body2",gutterBottom:!0,children:"Please sign in to GitLab to select a repository."}),(0,o.jsx)(p.A,{variant:"contained",color:"primary",onClick:E,style:{marginTop:8,marginRight:8},children:"Sign in to GitLab"}),(0,o.jsx)(p.A,{variant:"outlined",onClick:q,style:{marginTop:8},children:"Retry"}),z&&(0,o.jsx)(c.A,{color:"error",variant:"caption",display:"block",style:{marginTop:8},children:z})]}):P?(0,o.jsxs)(s.A,{p:2,style:{border:"1px solid #f0ad4e",borderRadius:4,backgroundColor:"#fcf8e3"},children:[(0,o.jsx)(c.A,{variant:"body1",gutterBottom:!0,style:{color:"#8a6d3b"},children:(0,o.jsx)("strong",{children:"Additional Permissions Required"})}),(0,o.jsxs)(c.A,{variant:"body2",gutterBottom:!0,children:["Your GitLab token has ",(0,o.jsx)("code",{children:S})," scope, but ",(0,o.jsx)("code",{children:"read_api"})," is required."]}),(0,o.jsxs)(c.A,{variant:"body2",gutterBottom:!0,style:{marginTop:8},children:["Please ask your administrator to add ",(0,o.jsx)("code",{children:"read_api"})," to the GitLab OAuth scopes in ",(0,o.jsx)("code",{children:"app-config.yaml"}),":"]}),(0,o.jsx)(s.A,{component:"pre",style:{backgroundColor:"#fff",padding:8,borderRadius:4,fontSize:"0.85em",overflow:"auto"},children:`auth:
  providers:
    gitlab:
      development:
        additionalScopes:
          - read_api`}),(0,o.jsxs)(c.A,{variant:"body2",gutterBottom:!0,style:{marginTop:8},children:["After the config is updated, revoke the app in"," ",(0,o.jsx)("a",{href:`https://${m}/-/profile/applications`,target:"_blank",rel:"noopener noreferrer",children:"GitLab Settings"})," ","and sign in again."]}),(0,o.jsx)(p.A,{variant:"contained",color:"primary",onClick:E,style:{marginTop:8,marginRight:8},children:"Sign in to GitLab"}),(0,o.jsx)(p.A,{variant:"outlined",onClick:q,style:{marginTop:8},children:"Retry"})]}):X?(0,o.jsxs)(s.A,{p:2,style:{border:"1px solid #d9534f",borderRadius:4,backgroundColor:"#f2dede"},children:[(0,o.jsx)(c.A,{variant:"body1",gutterBottom:!0,style:{color:"#a94442"},children:(0,o.jsx)("strong",{children:"Error Loading Groups"})}),(0,o.jsx)(c.A,{variant:"body2",gutterBottom:!0,children:X.message}),(0,o.jsx)(p.A,{variant:"outlined",onClick:q,style:{marginTop:8},children:"Retry"})]}):(0,o.jsxs)(u.A,{fullWidth:!0,error:r&&r.length>0,children:[(0,o.jsx)(b.Ay,{options:H||[],getOptionLabel:e=>e.full_path,loading:W,value:A,onChange:(e,r)=>{y(r),k(null),t("")},renderInput:e=>(0,o.jsx)(h.A,{...e,label:"Select Group (Owner Access)",variant:"outlined",margin:"normal",InputProps:{...e.InputProps,endAdornment:(0,o.jsxs)(l().Fragment,{children:[W?(0,o.jsx)(d.A,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}})}),(0,o.jsx)(b.Ay,{options:U||[],getOptionLabel:e=>e.name,loading:Y,value:v,onChange:(e,r)=>{if(k(r),r){let e=r.path_with_namespace.split("/").pop()||"";t(`${m}?owner=${encodeURIComponent(A?.full_path||"")}&repo=${encodeURIComponent(e)}`)}else t("")},disabled:!A,renderInput:e=>(0,o.jsx)(h.A,{...e,label:"Select Repository",variant:"outlined",margin:"normal",InputProps:{...e.InputProps,endAdornment:(0,o.jsxs)(l().Fragment,{children:[Y?(0,o.jsx)(d.A,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}})}),r&&r.length>0&&(0,o.jsx)(g.A,{error:!0,children:r[0]})]})}}))}}]);
//# sourceMappingURL=__federation_expose_default_export.a1449ffd.chunk.js.map